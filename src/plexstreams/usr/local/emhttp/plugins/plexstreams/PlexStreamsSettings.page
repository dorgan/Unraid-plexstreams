Menu="PlexStreams"
Title="Plex Stream Settings"
Tag="film"
---
<?php
include('/usr/local/emhttp/plugins/plexstreams/includes/config.php');
include('/usr/local/emhttp/plugins/plexstreams/includes/common.php');

function getToken() {
    global $cfg, $cfg_file;
    $host = "https://plex.tv/users/sign_in.json";
    $username = $cfg['USER'];
    $password = $cfg['PASSWORD'];

    $header = array(
        'Content-Length: 0', 
        'X-Plex-Client-Identifier: Unraid-Plex-Streams',
        'X-Plex-Product: Unraid-Plex-Streams',
        'X-Plex-Version: v1_06',
    );
    $process = curl_init($host);
    curl_setopt($process, CURLOPT_HTTPHEADER, $header);
    curl_setopt($process, CURLOPT_HEADER, 0);
    curl_setopt($process, CURLOPT_HTTPAUTH, CURLAUTH_BASIC);
    curl_setopt($process, CURLOPT_USERPWD, $username . ":" . $password);
    curl_setopt($process, CURLOPT_TIMEOUT, 30);
    curl_setopt($process, CURLOPT_SSL_VERIFYPEER, 0);
    curl_setopt($process, CURLOPT_POST, 1);
    curl_setopt($process, CURLOPT_RETURNTRANSFER, true);
    $data = curl_exec($process);

    $tokenResp = json_decode($data, true);
    @curl_close($process);
    if (isset($tokenResp['user']['authentication_token'])) {
        $newToken = $tokenResp['user']['authentication_token'];
        $cfg['TOKEN'] = $newToken;
        $handle = fopen($cfg_file,'w');
        if ($handle) {
            foreach($cfg as $key=>$value) {
                fwrite($handle, $key ."=\"" . $value ."\"" ."\n");
            }
            fclose($handle);
        }
    }
}

if (isset($cfg['USER']) && isset($cfg['PASSWORD'])) {
    if (!isset($cfg['TOKEN'])) {
        getToken();
    } elseif (empty($cfg['TOKEN'])) {
        getToken();
    }
}
if (!isset($cfg['DISPLAY_WIDGET'])) {
    $cfg['DISPLAY_WIDGET'] = "1";
}

if (!isset($cfg['DISPLAY_NAV'])) {
    $cfg['DISPLAY_NAV'] = "1";
}
$pluginPath = '/usr/local/emhttp/plugins/plexstreams/';

if ($cfg['DISPLAY_NAV'] === '0' && file_exists($pluginPath . 'Plex_Streams.page')) {
    rename($pluginPath .'Plex_Streams.page', $pluginPath .'Plex_Streams.page.off');
} else if ($cfg['DISPLAY_NAV'] === '1' && file_exists($pluginPath . 'Plex_Streams.page.off')) {
    rename($pluginPath .'Plex_Streams.page.off', $pluginPath .'Plex_Streams.page');
}

if ($cfg['DISPLAY_WIDGET'] === '0' && file_exists($pluginPath . 'PlexStreams_dashboard.page')) {
    rename($pluginPath .'PlexStreams_dashboard.page', $pluginPath .'PlexStreams_dashboard.page.off');
} else if ($cfg['DISPLAY_WIDGET'] === '1' && file_exists($pluginPath . 'PlexStreams_dashboard.page.off')) {
    rename($pluginPath .'PlexStreams_dashboard.page.off', $pluginPath .'PlexStreams_dashboard.page');
}
?>

<script>
function clearToken() {
    document.getElementById('plex-token').value = '';
    document.getElementById('plexstreams_settings').submit();
}
</script>
<form markdown="1" name="plexstreams_settings" id="plexstreams_settings" method="POST" action="/update.php" target="progressFrame">
<input type="hidden" name="#file" value="plexstreams/plexstreams.cfg" />
<input type="hidden" id="COMMAND" name="#command" value="" />

<input type="button" value="Get Plex Token" style="margin-right:0px;" onclick="PlexOAuth(function(token){document.getElementById('plex-token').value = token;});"/>
<input type="input" id="plex-token" name="TOKEN" value="<?php echo($cfg['TOKEN']) ?>" readonly="true"  style="height:25px;padding:5px;"/> 

<?php
    if (isset($cfg['TOKEN']) && $cfg['TOKEN'] !== '') {
        $servers = getServers($cfg);
        echo( '
            <div>
                Server:
                <select name="HOST">
        ');
        foreach($servers as $server) {
            foreach($server['IP'] as $ip) {
                echo('<option value="'  .$ip .'"' .($cfg['HOST'] === $ip ? ' selected="selected"' : '') . '>' .$server['Name'] .' (' . $ip .')' . '</option>');
            }
        }
        echo('
                </select>
            </div>
        ');
    }
?>
<div>
    Display in Nav:
    <input type="radio" name="DISPLAY_NAV" id="DISPLAY_NAV_ON" value="1"  <?php echo( $cfg['DISPLAY_NAV'] === "1" ? "checked" : ""); ?>/>On
    <input type="radio" name="DISPLAY_NAV" id="DISPLAY_NAV_OFF" value="0"  <?php echo( $cfg['DISPLAY_NAV'] === "0" ? "checked" : ""); ?>/>Off
</div>
<div>
    Display Dashboard Widget:
    <input type="radio" name="DISPLAY_WIDGET" id="DISPLAY_WIDGET_ON" value="1"  <?php echo( $cfg['DISPLAY_WIDGET'] === "1" ? "checked" : ""); ?>/>On
    <input type="radio" name="DISPLAY_WIDGET" id="DISPLAY_WIDGET_OFF" value="0"  <?php echo( $cfg['DISPLAY_WIDGET'] === "0" ? "checked" : ""); ?>/>Off
</div>
<input type="submit" value="SAVE"> <input type="button" value="Remove Token" onclick="clearToken()"/>
</form>
<script>
    var OS_VERSION = '<?php echo(OS_VERSION); ?>';
    var PLUGIN_VERSION = '<?php echo(PLUGIN_VERSION); ?>';
</script>
<script src="/plugins/plexstreams/js/plex.js" async="true"></script>