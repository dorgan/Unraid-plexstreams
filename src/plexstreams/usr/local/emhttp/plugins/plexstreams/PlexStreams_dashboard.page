Menu="Dashboard"
Icon="film"
Tag="film"
---
<?php
    include('/usr/local/emhttp/plugins/plexstreams/includes/common.php');
    include('/usr/local/emhttp/plugins/plexstreams/includes/config.php');
    $dashboard_widget_pos = 1;
    $dashboard_widget_colspan = 3;
    $streams = [];
    $streamCount = 0;

    if (!empty($cfg['TOKEN'])) {
        $host =  (substr($cfg['HOST'], -1) !== '/' ? $cfg['HOST'] : substr($cfg['HOST'],0,-1));
        $streams = getStreams($host, $cfg);

        if ($streams['@attributes']['size'] > 0) {
            if ((int)$streams['@attributes']['size'] === 1) {
                $streams['Video'] = [$streams['Video']];
            }
            $streamCount =$streams['@attributes']['size'];
        }
    }
?>

<style type="text/css">
        .dash_plexstreams_toggle{display:none}
</style>
<table id="db-box<?php echo $dashboard_widget_pos ?>" class="dash_plexstreams dashboard box<?php echo $dashboard_widget_pos ?>" style="display:none">
        <thead sort="10" class="sortable">
                <tr>
                        <td></td>
                        <td class="next" colspan="<?php echo $dashboard_widget_colspan ?>" style="white-space: no-wrap;">
                            <i style="font-size:32px;vertical-align:top;" class="fa fa-film icon"></i>
                                <div class="section" style="line-height:2rem;">Plex Streams<br><span><?php echo $streamCount ?> Active Stream(s)</span><br><br></div>
                                <i class="fa fa-fw chevron mt0" id="dash_plexstreams_toggle" onclick="toggleChevron('dash_plexstreams_toggle',0)"></i>
                                <a href="/Settings/PlexStreams" title="Plex Streams Setup page"><i class="fa fa-fw fa-cog chevron mt0"></i></a>
                                <a href="/Plex_Streams" title="View Streams"><i class="fa fa-fw fa-film chevron mt0"></i></a>
                        </td>
                        <td></td>
                </tr>
        </thead>
        <tbody class="dash_plexstreams_toggle sortable" style="display:table-row-group" sort="10">
                <tr>
                    <td></td>
                    <td colspan="<?php echo $dashboard_widget_colspan ?>" class="top">
                            <table>
                                <tbody style="display: table-row-group;">
                                <?php
                                    if ($streamCount > 0) {
                                ?>
                                    <tr style="display:table-row;">
                                        <td><strong>Name</strong></td>
                                        <td width="25%" align="center"><strong>Status</strong></td>
                                        <td width="25%" align="right"><strong>Time</strong></td>
                                    </tr>
                                    <?php
                                        foreach($streams['Video'] as $stream) {
                                            if (isset($stream['Media']['@attributes'])) {
                                                $stream['Media'] = [$stream['Media']];
                                            }
                                            
                                            foreach($stream['Media'] as $media) {
                                                if ($media['@attributes']['selected'] === '1') {
                                                    $title = $stream['@attributes']['title'] . ' (' . $stream['@attributes']['year'] . ')';
                                                    if (isset($stream['@attributes']['parentTitle'])) {
                                                        $title = $stream['@attributes']['parentTitle'] . ' - ' . $title;
                                                    }
                                                    if (isset($stream['@attributes']['grandparentTitle'])) {
                                                        $title = $stream['@attributes']['grandparentTitle'] . ' - ' . $title;
                                                    }
                                                    $length = floatval($media['Part']['@attributes']['duration']);
                                                    $lengthInSeconds =  floatval($length) / 1000;
                                                    $lengthInMinutes = ceil(($lengthInSeconds / 60 ));
                                                    
                                                    $lengthSeconds = floor($lengthInSeconds%60);
                                                    $lengthMinutes = floor(($lengthInSeconds%3600)/60);
                                                    $lengthHours = floor(($lengthInSeconds%86400)/3600);

                                                    $currentPosition = floatval((int)$stream['@attributes']['viewOffset']);
                                                    $currentPositionInSeconds = $currentPosition / 1000;
                                                    $currentPositionInMinutes = ceil($currentPositionInSeconds / 60);

                                                    $currentPositionSeconds = floor($currentPositionInSeconds%60);
                                                    $currentPositionMinutes = floor(($currentPositionInSeconds%3600)/60);
                                                    $currentPositionHours = floor(($currentPositionInSeconds%86400)/3600);

                                                    $percentPlayed = round(($currentPositionInMinutes/ $lengthInMinutes) * 100, 0);

                                                    $currentPositionDisplay = str_pad($currentPositionHours, 2, '0', STR_PAD_LEFT) . ':' . str_pad($currentPositionMinutes, 2, '0', STR_PAD_LEFT) . ':' . str_pad($currentPositionSeconds, 2, '0', STR_PAD_LEFT);
                                                    $lengthDisplay = str_pad($lengthHours, 2, '0', STR_PAD_LEFT) . ':' . str_pad($lengthMinutes, 2, '0', STR_PAD_LEFT) . ':' . str_pad($lengthSeconds, 2, '0', STR_PAD_LEFT);
                                                    $state = $stream['Player']['@attributes']['state'];
                                                    
                                                    $stateIcon = 'play';
                                                    if ($state === 'paused') {
                                                        $stateIcon = 'pause';
                                                    } else if ($state !== 'playing') {
                                                        $stateIcon = 'buffer';
                                                    }
                                                    echo('
                                                        <tr style="display:table-row;">
                                                            <td><p class="plexstream-title">' .$title .'</p></td>
                                                            <td align="center"><i class="fa fa-' .$stateIcon  . '" title="' . $state . '"></i></td>
                                                            <td align="right">' .$currentPositionDisplay .' / ' . $lengthDisplay .'</td>
                                                        </td>
                                                    ');
                                                }
                                            }
                                        }
                                    ?>
                                    </tbody>
                                <?php
                                } else {
                                    echo('<tr><td colspan="3"><i>There are currently no active streams</i></td></tr>');
                                }
                                ?>
                            </table>
                    </td>
                    <td></td>
                </tr>
        </tbody>
</table>
<style>
p.plexstream-title {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    width: 240px;
    padding-right:20px
}
</style>

<script>
$(function() {
  // append data from the table into the correct one
  $("#db-box<?php echo $dashboard_widget_pos ?>").append($(".dash_plexstreams").html());

  // reload toggle to get the correct state
  toggleView('dash_plexstreams_toggle',true);

  // reload sorting to get the stored data (cookie)
  sortTable($('#db-box1'),$.cookie('db-box1'));
  sortTable($('#db-box2'),$.cookie('db-box2'));
  sortTable($('#db-box3'),$.cookie('db-box3'));
});
</script>